---
title: "go_annotation"
author: "marcial"
date: "2025-09-26"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
# This script performs Gene Ontology (GO) enrichment analysis using the topGO package,
# processes the results, and then generates a complex scatter plot to visualize
# the enriched terms in a "semantic space."

# --- 1. SET CRAN MIRROR AND INSTALL/LOAD PACKAGES ---
options(repos = "https://cran.rstudio.com")

if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

required_packages <- c("topGO", "Rgraphviz", "org.Mm.eg.db", "ggplot2", "dplyr", "viridis")
for(pkg in required_packages) {
  if (!require(pkg, character.only = TRUE)) {
    cat(paste0("Installing ", pkg, "...\n"))
    if (pkg %in% c("topGO", "Rgraphviz", "org.Mm.eg.db")) {
      BiocManager::install(pkg)
    } else {
      install.packages(pkg)
    }
    library(pkg, character.only = TRUE)
  }
}

# --- 2. PREPARE INPUT DATA ---
if (!file.exists("eggnog_results.csv")) {
  stop("ERROR: The file 'eggnog_results.csv' was not found. Please ensure it is in the same folder.")
}
if (!file.exists("protein_ids.txt")) {
  stop("ERROR: The file 'protein_ids.txt' was not found. Please ensure it is in the same folder.")
}

eggnog_results <- read.csv("eggnog_results.csv", header = TRUE, stringsAsFactors = FALSE)

if (!"query" %in% names(eggnog_results) || !"GOs" %in% names(eggnog_results)) {
  stop("ERROR: The 'eggnog_results.csv' is missing the required 'query' or 'GOs' columns.")
}

genes_of_interest <- readLines("protein_ids.txt")

# --- 3. CREATE GENE-GO MAPPING ---
go_mapping <- list()
for (i in 1:nrow(eggnog_results)) {
  gene_id <- eggnog_results$query[i]
  go_terms_string <- eggnog_results$GOs[i]
  if (!is.na(go_terms_string) && go_terms_string != "" && go_terms_string != "-") {
    go_terms <- strsplit(go_terms_string, ",")[[1]]
    go_mapping[[gene_id]] <- go_terms
  }
}

if (length(go_mapping) == 0) {
  stop("ERROR: No GO terms were found in 'eggnog_results.csv'. Please check your input file.")
}

# --- 4. PREPARE THE DATA FOR TOPGO ---
gene_list_factor <- as.factor(as.integer(eggnog_results$query %in% genes_of_interest))
names(gene_list_factor) <- eggnog_results$query

# --- 5. RUN THE GO ENRICHMENT ANALYSIS ---
# Create topGOdata objects for each ontology
GOdata_BP <- new("topGOdata", ontology = "BP", allGenes = gene_list_factor, annot = annFUN.gene2GO, gene2GO = go_mapping, nodeSize = 10)
GOdata_MF <- new("topGOdata", ontology = "MF", allGenes = gene_list_factor, annot = annFUN.gene2GO, gene2GO = go_mapping, nodeSize = 10)
GOdata_CC <- new("topGOdata", ontology = "CC", allGenes = gene_list_factor, annot = annFUN.gene2GO, gene2GO = go_mapping, nodeSize = 10)

# Run Fisher's exact test
resultFisher_BP <- runTest(GOdata_BP, algorithm = "classic", statistic = "fisher")
resultFisher_MF <- runTest(GOdata_MF, algorithm = "classic", statistic = "fisher")
resultFisher_CC <- runTest(GOdata_CC, algorithm = "classic", statistic = "fisher")

# --- 6. COMBINE AND PROCESS RESULTS FOR PLOTTING ---
# Generate tables from the topGO results
go_table_BP <- GenTable(GOdata_BP, classicFisher = resultFisher_BP, topNodes = 20) %>%
  mutate(function_type = "BP")
go_table_MF <- GenTable(GOdata_MF, classicFisher = resultFisher_MF, topNodes = 20) %>%
  mutate(function_type = "MF")
go_table_CC <- GenTable(GOdata_CC, classicFisher = resultFisher_CC, topNodes = 20) %>%
  mutate(function_type = "CC")

# Combine the results into a single data frame
combined_go_data <- bind_rows(go_table_BP, go_table_MF, go_table_CC)

# --- 7. GENERATE SYNTHETIC SEMANTIC COORDINATES AND UNIQUENESS ---
# NOTE: In a real analysis, these values would be generated by a separate
# semantic similarity analysis tool (e.g., REVIGO). We are using random
# values here as a placeholder for demonstration purposes.

set.seed(42) # For reproducibility
combined_go_data <- combined_go_data %>%
  mutate(
    semantic_x = runif(nrow(.), -100, 100),
    semantic_y = runif(nrow(.), -100, 100),
    uniqueness = runif(nrow(.), 0.2, 0.9)
  )

# --- 8. CREATE THE PLOT WITH MULTIPLE VISUAL MAPPINGS ---
# We use geom_point() with shape=21 to allow for separate fill and border colors.
p <- ggplot(combined_go_data, aes(x = semantic_x, y = semantic_y)) +
  
  # Add the circles, mapping aesthetics to our data variables
  geom_point(aes(size = Annotated,          # Circle size (number of genes)
                 fill = uniqueness,        # Inner circle color (uniqueness)
                 color = function_type),   # Circle border color (function type)
             shape = 21,
             alpha = 0.8) +
  
  # Set the continuous fill color scale for uniqueness.
  scale_fill_viridis(option = "plasma", direction = -1,
                     name = "Uniqueness Score",
                     guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  
  # Set the manual color scale for the categorical function type.
  scale_color_manual(values = c("BP" = "#1f77b4", "MF" = "#ff7f0e", "CC" = "#2ca02c"),
                     name = "Function Type",
                     guide = guide_legend(override.aes = list(fill = "gray"))) +
  
  # Set the size scale. Here, we can also customize the legend.
  scale_size_continuous(range = c(2, 20),
                        name = "Number of Genes",
                        breaks = c(10, 50, 100, 200)) +
  
  # Add labels and theme
  labs(title = "Semantic Space Visualization of GO Terms",
       subtitle = "Circle size for genes, fill for uniqueness, border for function type",
       x = "Semantic Space X",
       y = "Semantic Space Y") +
  
  theme_minimal(base_size = 14) +
  
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

# --- 9. DISPLAY AND SAVE THE PLOT ---
print(p)

ggsave("semantic_space_plot.png", plot = p, width = 10, height = 8, dpi = 300)
cat("Plot saved as semantic_space_plot.png\n")

```
```{r}
# --- 1. SET UP THE ENVIRONMENT ---
# Ensure you have the necessary packages installed.
# If not, you can install them with install.packages("ggplot2") and install.packages("viridis").
library(ggplot2)
library(viridis)

# --- 2. LOAD YOUR DATA ---
# This script assumes that the 'combined_go_data' data frame, which you created
# in the previous step by combining the BP, MF, and CC enrichment results,
# is already loaded in your R session.

# If you need to re-create the dummy data for testing, you can use the code below:
# combined_go_data <- data.frame(
#   GO.ID = paste0("GO:", sample(1000:9999, 60)),
#   Term = paste0("Term", 1:60),
#   Annotated = c(sample(50:1500, 20), sample(10:800, 20), sample(10:2000, 20)),
#   Significant = c(sample(1:20, 20), sample(1:15, 20), sample(1:25, 20)),
#   Expected = runif(60, 0.5, 5),
#   classicFisher = runif(60, 0, 0.05),
#   function_type = rep(c("CC", "MF", "BP"), each = 20),
#   semantic_x = runif(60, -1, 1),
#   semantic_y = runif(60, -1, 1),
#   uniqueness = runif(60, 0.1, 1)
# )

# --- 3. CREATE THE FACETED PLOT ---
# Instead of mapping the border color, we use 'facet_wrap' to create a separate
# panel for each function type (BP, MF, CC).
# This makes the comparison between the categories much clearer.
p_faceted <- ggplot(combined_go_data, aes(x = semantic_x, y = semantic_y)) +
  
  # Use geom_point to add the circles.
  # We map the size to the number of annotated genes and the fill color
  # to the uniqueness score.
  geom_point(aes(size = Annotated,
                 fill = uniqueness),
             shape = 21,
             color = "black", # Set a uniform, dark border for better contrast
             alpha = 0.8) +
  
  # Create the separate panels for each function type.
  # The 'scales = "free"' argument allows each panel to have its own
  # independent axes, which can be helpful if the data ranges vary a lot.
  facet_wrap(~ function_type) +
  
  # Set the continuous fill color scale for uniqueness.
  scale_fill_viridis(option = "plasma", direction = -1,
                     name = "Uniqueness Score",
                     guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  
  # Set the size scale.
  scale_size_continuous(range = c(2, 20),
                        name = "Number of Genes",
                        breaks = c(10, 50, 100, 200)) +
  
  # Add labels and theme
  labs(title = "Semantic Space Visualization of GO Terms",
       subtitle = "Grouped by Biological Function",
       x = "Semantic Space X",
       y = "Semantic Space Y") +
  
  theme_minimal(base_size = 14) +
  
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    strip.text = element_text(face = "bold", size = 16) # Make facet titles stand out
  )

# --- 4. DISPLAY THE PLOT ---
print(p_faceted)
```


```{r}
# --- 1. SET UP THE ENVIRONMENT AND LIBRARIES ---
# The 'ggrepel' library is necessary for geom_label_repel().
# If you haven't installed it yet, run this line in your R console:
# install.packages("ggrepel")
# The 'viridis' library is for the beautiful color scale.
# install.packages("viridis")

# Now, load the libraries required for the plot.
library(ggplot2)
library(viridis)
library(ggrepel)

# --- 2. LOAD YOUR DATA ---
# This script assumes that the 'combined_go_data' data frame, which you created
# by combining the BP, MF, and CC enrichment results, is already loaded in your R session.
# If you need to re-create the dummy data for testing, you can use the code below:
# combined_go_data <- data.frame(
#   GO.ID = paste0("GO:", sample(1000:9999, 60)),
#   Term = paste0("Term", 1:60),
#   Annotated = c(sample(50:1500, 20), sample(10:800, 20), sample(10:2000, 20)),
#   Significant = c(sample(1:20, 20), sample(1:15, 20), sample(1:25, 20)),
#   Expected = runif(60, 0.5, 5),
#   classicFisher = runif(60, 0, 0.05),
#   function_type = rep(c("CC", "MF", "BP"), each = 20),
#   semantic_x = runif(60, -1, 1),
#   semantic_y = runif(60, -1, 1),
#   uniqueness = runif(60, 0.1, 1)
# )

# --- 3. CREATE A SUBSET FOR LABELS ---
# We'll create a new data frame containing only the terms we want to label.
# This makes the plot less cluttered and easier to read.
# I'm selecting terms that have more than 30 annotated genes AND a uniqueness score
# greater than 0.5. You can adjust these thresholds as you see fit.
label_data <- combined_go_data[
  combined_go_data$Annotated > 30 & combined_go_data$uniqueness > 0.5,
]

# --- 4. CREATE THE FACETED PLOT WITH LABELS ---
p_labeled_faceted <- ggplot(combined_go_data, aes(x = semantic_x, y = semantic_y)) +
  
  # Add the circles, using the full dataset.
  geom_point(aes(size = Annotated,
                 fill = uniqueness),
             shape = 21,
             color = "black", # Set a uniform, dark border for better contrast.
             alpha = 0.8) +
  
  # Add labels to the points, using our filtered 'label_data'.
  # geom_label_repel() will automatically adjust the position to prevent overlap.
  geom_label_repel(data = label_data,
                   aes(label = Term, size = NULL), # Map label to the 'Term' column.
                   box.padding = 0.5,
                   point.padding = 0.5,
                   min.segment.length = 0.5,
                   force = 2,
                   seed = 42) +
  
  # Create the separate panels for each function type.
  facet_wrap(~ function_type) +
  
  # Set the continuous fill color scale for uniqueness.
  scale_fill_viridis(option = "plasma", direction = -1,
                     name = "Uniqueness Score",
                     guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  
  # Set the size scale.
  scale_size_continuous(range = c(2, 20),
                        name = "Number of Genes",
                        breaks = c(10, 50, 100, 200, 500, 1000)) +
  
  # Add labels and theme
  labs(title = "Semantic Space Visualization of GO Terms",
       subtitle = "Grouped by Biological Function",
       x = "Semantic Space X",
       y = "Semantic Space Y") +
  
  theme_minimal(base_size = 14) +
  
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    strip.text = element_text(face = "bold", size = 16)
  )

# --- 5. DISPLAY THE PLOT ---
print(p_labeled_faceted)
```


```{r}
# --- 1. SET UP THE ENVIRONMENT AND LIBRARIES ---
# Load the necessary libraries.
library(ggplot2)
library(viridis)
library(ggrepel)

# --- 2. LOAD YOUR DATA ---
# This script assumes that the 'combined_go_data' data frame, which you created
# by combining the BP, MF, and CC enrichment results, is already loaded in your R session.
# If you need to re-create the dummy data for testing, you can use the code below:
# combined_go_data <- data.frame(
#   GO.ID = paste0("GO:", sample(1000:9999, 60)),
#   Term = paste0("Term", 1:60),
#   Annotated = c(sample(50:1500, 20), sample(10:800, 20), sample(10:2000, 20)),
#   Significant = c(sample(1:20, 20), sample(1:15, 20), sample(1:25, 20)),
#   Expected = runif(60, 0.5, 5),
#   classicFisher = runif(60, 0, 0.05),
#   function_type = rep(c("CC", "MF", "BP"), each = 20),
#   semantic_x = runif(60, -1, 1),
#   semantic_y = runif(60, -1, 1),
#   uniqueness = runif(60, 0.1, 1)
# )

# --- 3. CREATE A SUBSET FOR LABELS ---
# We'll create a new data frame containing only the terms we want to label.
label_data <- combined_go_data[
  combined_go_data$Annotated > 30 & combined_go_data$uniqueness > 0.5,
]

# --- 4. CREATE THE FACETED PLOT WITH LABELS AND CORRECT LEGENDS ---
p_labeled_faceted <- ggplot(combined_go_data, aes(x = semantic_x, y = semantic_y)) +
  
  # Add the circles, using the full dataset.
  geom_point(aes(size = Annotated,
                 fill = uniqueness),
             shape = 21,
             color = "black",
             alpha = 0.8) +
  
  # Add labels to the points, using our filtered 'label_data'.
  geom_label_repel(data = label_data,
                   aes(label = Term),
                   size = 5, # You can manually adjust this size.
                   box.padding = 0.5,
                   point.padding = 0.5,
                   min.segment.length = 0.5,
                   force = 2,
                   seed = 42,
                   show.legend = FALSE) + # <-- THIS IS THE KEY FIX
  
  # Create the separate panels for each function type.
  facet_wrap(~ function_type) +
  
  # Set the continuous fill color scale for uniqueness.
  scale_fill_viridis(option = "plasma", direction = -1,
                     name = "Uniqueness Score",
                     guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  
  # Fix the size legend by explicitly setting its guide.
  scale_size_continuous(range = c(2, 20),
                        name = "Number of Genes",
                        breaks = c(10, 50, 100, 200, 500, 1000)) +
  
  # Add labels and theme
  labs(title = "Semantic Space Visualization of GO Terms",
       subtitle = "Grouped by Biological Function",
       x = "Semantic Space X",
       y = "Semantic Space Y") +
  
  theme_minimal(base_size = 14) +
  
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    strip.text = element_text(face = "bold", size = 16)
  )

# --- 5. DISPLAY THE PLOT ---
print(p_labeled_faceted)
```

